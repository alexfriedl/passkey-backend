<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Passkey Login</title>
  </head>
  <body>
    <h1>Passkey Login</h1>
    <input type="text" id="username" placeholder="Benutzername" />
    <button onclick="login()">Login</button>
    <p id="status"></p>

    <script>
      /**
       * Gets callback scheme from URL parameters
       * @returns {string} The callback scheme (default: 'passkeyguard')
       */
      function getCallbackScheme() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('callbackScheme') || 'passkeyguard';
      }

      /**
       * Checks if request came from a mobile app
       * @returns {boolean}
       */
      function isFromMobileApp() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('originApp') !== null;
      }

      /**
       * Navigates back to the calling app via deeplink
       * @param {'success' | 'error'} status - The completion status
       * @param {string | null} username - The username (optional)
       * @param {string | null} errorMsg - Error message for error status (optional)
       * @returns {boolean} - Whether navigation was triggered
       */
      function navigateBackToApp(status, username = null, errorMsg = null) {
        if (!isFromMobileApp()) {
          console.log('Not from mobile app - skipping deeplink callback');
          return false;
        }

        const scheme = getCallbackScheme();
        const params = new URLSearchParams();
        params.set('status', status);

        switch (status) {
          case 'success':
            if (username) params.set('username', username);
            break;
          case 'error':
            params.set('error', errorMsg || 'Unknown error');
            break;
        }

        const deeplink = `${scheme}://webauthn-completion?${params.toString()}`;
        console.log(`Navigating back to app: ${deeplink}`);
        window.location.href = deeplink;
        return true;
      }

      // Auto-start login if opened from app
      window.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);

        // Read username from URL and fill input
        if (urlParams.get('username')) {
          document.getElementById('username').value = urlParams.get('username');
        }

        if (urlParams.get('hw') === 'true' && urlParams.get('username')) {
          // Auto-start login when opened from PasskeyGuard app
          setTimeout(() => {
            login();
          }, 1000);
        }
      });

      async function login() {
        try {
          const username = document.getElementById("username").value;
          if (!username) {
            alert("Bitte einen Benutzernamen eingeben!");
            return;
          }

          console.log("üì¢ Login gestartet f√ºr:", username);

          // Schritt 1: Login-Challenge vom Server holen
          const API_URL = "/api";
          const res = await fetch(
            `${API_URL}/login`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ username }),
            }
          );

          const options = await res.json();
          console.log("üì• Empfangene `options` vom Server:", options);

          // Sicherstellen, dass `challenge` als ArrayBuffer vorliegt
          if (typeof options.challenge === "string") {
            console.log("üîÑ `challenge` ist Base64. Wird in ArrayBuffer konvertiert.");
            options.challenge = base64ToArrayBuffer(options.challenge);
          } else if (!(options.challenge instanceof ArrayBuffer)) {
            throw new Error("‚ùå Challenge hat falsches Format!");
          }

          // Konvertiere `allowCredentials` falls vorhanden
          if (Array.isArray(options.allowCredentials)) {
            options.allowCredentials = options.allowCredentials.map((cred) => ({
              ...cred,
              id: base64ToArrayBuffer(cred.id),
            }));
          } else {
            console.warn("‚ö†Ô∏è `allowCredentials` fehlt oder hat falsches Format.");
          }

          console.log("üîÑ `challenge` und `allowCredentials` konvertiert.");

          // F√ºr den Login-Flow entfernen wir das attestation-Feld,
          // da es hier nicht ben√∂tigt wird und zu Konflikten f√ºhren kann.
          if (options.attestation) {
            console.log("üîÑ Entferne attestation-Feld aus Options.");
            delete options.attestation;
          }

          // Schritt 2: WebAuthn-Authentifizierung starten
          console.log("üîë WebAuthn-Login wird gestartet...");
          const credential = await navigator.credentials.get({
            publicKey: options,
          });

          console.log("üÜï Erhaltene WebAuthn-Credentials:", credential);

          // Umwandlung von ArrayBuffer in Base64 f√ºr die Antwortdaten
          const credentialData = {
            id: credential.id,
            rawId: arrayBufferToBase64(credential.rawId),
            response: {
              authenticatorData: arrayBufferToBase64(
                credential.response.authenticatorData
              ),
              clientDataJSON: arrayBufferToBase64(
                credential.response.clientDataJSON
              ),
              signature: arrayBufferToBase64(credential.response.signature),
              userHandle: credential.response.userHandle
                ? arrayBufferToBase64(credential.response.userHandle)
                : null,
            },
            type: credential.type,
          };

          console.log("üì§ Sende Credential-Daten an den Server:", credentialData);

          // Schritt 3: Anmeldung beim Server verifizieren
          const verifyRes = await fetch(
            `${API_URL}/login/verify`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                username,
                assertion: credentialData,
              }),
            }
          );

          const verifyResult = await verifyRes.json();
          console.log("‚úÖ Server-Antwort auf `login/verify`:", verifyResult);

          if (verifyResult.success) {
            document.getElementById("status").textContent = "Login erfolgreich!";
            navigateBackToApp('success', username);
          } else {
            const errorMsg = verifyResult.error || "Unbekannter Fehler";
            document.getElementById("status").textContent = "Fehler beim Login: " + errorMsg;
            navigateBackToApp('error', username, errorMsg);
          }
        } catch (error) {
          console.error("‚ùå Fehler beim Login:", error);
          document.getElementById("status").textContent =
            "Fehler beim Login: " + error.message;
          navigateBackToApp('error', null, error.message);
        }
      }

      // Hilfsfunktion: Base64URL in ArrayBuffer umwandeln
      function base64ToArrayBuffer(base64) {
        // Fix: Handle non-string inputs
        if (base64 == null || typeof base64 !== 'string') {
          console.error('base64ToArrayBuffer: Invalid input:', base64, typeof base64);
          return new ArrayBuffer(0);
        }
        
        try {
          const binary = atob(base64.replace(/-/g, "+").replace(/_/g, "/"));
          const bytes = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
          }
          return bytes.buffer;
        } catch (error) {
          console.error('base64ToArrayBuffer: Error converting:', error);
          return new ArrayBuffer(0);
        }
      }

      // Hilfsfunktion: ArrayBuffer in Base64URL umwandeln
      function arrayBufferToBase64(buffer) {
        let binary = "";
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary)
          .replace(/\+/g, "-")
          .replace(/\//g, "_")
          .replace(/=+$/, "");
      }
    </script>
  </body>
</html>
