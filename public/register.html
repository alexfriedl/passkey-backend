<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Passkey Registrierung</title>
  </head>
  <body>
    <h1>Passkey Registrierung</h1>
    <input type="text" id="username" placeholder="Benutzername" />
    <button onclick="register()">Registrieren</button>
    <pre id="status"></pre>

    <script>
      function arrayBufferToBase64(buffer) {
        let binary = "";
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary)
          .replace(/\+/g, "-")
          .replace(/\//g, "_")
          .replace(/=+$/, "");
      }

      function base64ToArrayBuffer(base64) {
        const binary = atob(base64.replace(/-/g, "+").replace(/_/g, "/"));
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
      }

      async function register() {
        const API_URL = "https://www.appsprint.de/api";
        const username = document.getElementById("username").value;
        if (!username) {
          alert("Bitte einen Benutzernamen eingeben!");
          return;
        }
        document.getElementById("status").textContent =
          "Registrierung startet…";

        // Schritt 1: Challenge abrufen
        const res = await fetch(`${API_URL}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username }),
        });
        const options = await res.json();

        // Sicherstellen, dass Challenge und user.id als ArrayBuffer vorliegen
        if (typeof options.challenge === "string") {
          options.challenge = base64ToArrayBuffer(options.challenge);
        }
        if (typeof options.user.id === "string") {
          options.user.id = base64ToArrayBuffer(options.user.id);
        }

        // Schritt 2: Passkey-Erstellung
        let credential;
        try {
          credential = await navigator.credentials.create({
            publicKey: options,
          });
        } catch (err) {
          document.getElementById("status").textContent =
            "Fehler bei credential.create: " + err;
          return;
        }

        const credentialData = {
          id: credential.id,
          rawId: arrayBufferToBase64(credential.rawId),
          response: {
            attestationObject: arrayBufferToBase64(
              credential.response.attestationObject
            ),
            clientDataJSON: arrayBufferToBase64(
              credential.response.clientDataJSON
            ),
          },
          type: credential.type,
        };

        // Schritt 3: Registrierungsabschluss beim Server
        const verifyRes = await fetch(`${API_URL}/register/verify`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, credential: credentialData }),
        });
        const verifyResult = await verifyRes.json();

        // Nach erfolgreicher Registrierung, Deeplink zurück zur App
        if (verifyResult.success) {
          document.getElementById("status").textContent =
            "Registrierung erfolgreich!";
          // Hier wird der Deeplink erzeugt (z. B. localkey://registration-success?token=...&username=...)
          // Angenommen, der Server liefert einen Token in verifyResult.token:
          const token = verifyResult.token || "dummyToken";
          const deeplink = `localkey://registration-success?token=${encodeURIComponent(
            token
          )}&username=${encodeURIComponent(username)}`;
          window.location.href = deeplink;
        } else {
          document.getElementById("status").textContent =
            "Registrierung fehlgeschlagen: " +
            (verifyResult.error || "Unbekannter Fehler");
        }
      }
    </script>
  </body>
</html>
