<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Discoverable Login (Usernameless)</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 40px;
        background: #f5f5f5;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #28a745;
        text-align: center;
      }
      .flow-info {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .flow-info h3 {
        margin-top: 0;
        color: #155724;
      }
      button {
        background: #28a745;
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 18px;
        width: 100%;
        margin: 10px 0;
      }
      button:hover {
        background: #218838;
      }
      #status {
        margin-top: 20px;
        padding: 10px;
        border-radius: 4px;
      }
      #debugLog {
        border: 1px solid #ccc;
        padding: 0.5em;
        background: #f7f7f7;
        white-space: pre-wrap;
        margin-top: 1em;
        max-height: 300px;
        overflow: auto;
        font-size: 12px;
      }
      .tech-details {
        background: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        margin-top: 20px;
        font-size: 14px;
      }
      .tech-details code {
        background: #dee2e6;
        padding: 2px 5px;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Discoverable Login</h1>

      <div class="flow-info">
        <h3>Was ist Discoverable/Resident Key?</h3>
        <p><strong>Kein Username erforderlich!</strong></p>
        <p>iOS zeigt automatisch ALLE Passkeys fuer diese Domain an. Der Benutzer waehlt einfach seinen Passkey aus.</p>
        <p><code>allowCredentials: []</code> (leere Liste)</p>
      </div>

      <button onclick="discoverableLogin()">Mit Passkey anmelden</button>
      <button onclick="openViaDeeplink()" style="background: #6c757d; margin-top: 5px;">Via Deeplink (PasskeyGuard)</button>

      <div id="status"></div>

      <div class="tech-details">
        <strong>Technischer Ablauf:</strong>
        <ol>
          <li>Client ruft <code>/api/login/discoverable</code> auf</li>
          <li>Server antwortet mit <code>allowCredentials: []</code></li>
          <li>iOS zeigt alle verfuegbaren Passkeys</li>
          <li>Benutzer waehlt einen Passkey</li>
          <li>Client sendet Assertion zur Verifikation</li>
        </ol>
      </div>

      <div id="debugLog"></div>
    </div>

    <script>
      function logDebug(message) {
        console.log(message);
        const debugLog = document.getElementById("debugLog");
        const timestamp = new Date().toLocaleTimeString();
        debugLog.textContent += `[${timestamp}] ${message}\n`;
        debugLog.scrollTop = debugLog.scrollHeight;
      }

      function updateStatus(message, type = 'info') {
        const status = document.getElementById('status');
        const colors = {
          info: '#d1ecf1',
          success: '#d4edda',
          error: '#f8d7da',
          warning: '#fff3cd'
        };
        status.style.background = colors[type] || colors.info;
        status.innerHTML = message;
      }

      /**
       * Gets callback scheme from URL parameters
       * @returns {string} The callback scheme (default: 'passkeyguard')
       */
      function getCallbackScheme() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('callbackScheme') || 'passkeyguard';
      }

      /**
       * Checks if request came from a mobile app
       * @returns {boolean}
       */
      function isFromMobileApp() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('originApp') !== null;
      }

      /**
       * Navigates back to the calling app via deeplink
       * @param {'success' | 'error'} status - The completion status
       * @param {string | null} username - The username (optional)
       * @param {string | null} errorMsg - Error message for error status (optional)
       * @returns {boolean} - Whether navigation was triggered
       */
      function navigateBackToApp(status, username = null, errorMsg = null) {
        if (!isFromMobileApp()) {
          logDebug('Not from mobile app - skipping deeplink callback');
          return false;
        }

        const scheme = getCallbackScheme();
        const params = new URLSearchParams();
        params.set('status', status);

        switch (status) {
          case 'success':
            if (username) params.set('username', username);
            break;
          case 'error':
            params.set('error', errorMsg || 'Unknown error');
            break;
        }

        const deeplink = `${scheme}://webauthn-completion?${params.toString()}`;
        logDebug(`Navigating back to app: ${deeplink}`);
        window.location.href = deeplink;
        return true;
      }

      // Hilfsfunktion: Base64URL in ArrayBuffer umwandeln
      function base64ToArrayBuffer(base64) {
        if (base64 == null || typeof base64 !== 'string') {
          console.error('base64ToArrayBuffer: Invalid input:', base64, typeof base64);
          return new ArrayBuffer(0);
        }

        try {
          const binary = atob(base64.replace(/-/g, "+").replace(/_/g, "/"));
          const bytes = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
          }
          return bytes.buffer;
        } catch (error) {
          console.error('base64ToArrayBuffer: Error converting:', error);
          return new ArrayBuffer(0);
        }
      }

      // Hilfsfunktion: ArrayBuffer in Base64URL umwandeln
      function arrayBufferToBase64(buffer) {
        let binary = "";
        const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary)
          .replace(/\+/g, "-")
          .replace(/\//g, "_")
          .replace(/=+$/, "");
      }

      async function discoverableLogin() {
        const API_URL = "/api";

        try {
          updateStatus('Starte Discoverable Login...', 'info');
          logDebug('=== DISCOVERABLE LOGIN START ===');
          logDebug('Kein Username erforderlich - iOS zeigt alle Passkeys');

          // Schritt 1: Challenge vom Server holen (OHNE Username!)
          logDebug('Hole Challenge von /api/login/discoverable...');
          const res = await fetch(`${API_URL}/login/discoverable`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}) // Kein Username!
          });

          const options = await res.json();
          logDebug('Server-Antwort erhalten:');
          logDebug(JSON.stringify(options, null, 2));

          // Pruefe allowCredentials
          logDebug(`allowCredentials: ${JSON.stringify(options.allowCredentials)}`);
          if (options.allowCredentials && options.allowCredentials.length > 0) {
            logDebug('WARNUNG: allowCredentials ist nicht leer! Das ist NICHT Discoverable!');
          } else {
            logDebug('OK: allowCredentials ist leer -> Discoverable Flow');
          }

          // Speichere sessionId fuer spaeter
          const sessionId = options.sessionId;
          logDebug(`Session ID: ${sessionId}`);

          // Challenge konvertieren
          if (typeof options.challenge === "string") {
            logDebug('Konvertiere challenge von Base64 zu ArrayBuffer');
            options.challenge = base64ToArrayBuffer(options.challenge);
          }

          // allowCredentials sollte leer sein
          options.allowCredentials = [];

          updateStatus('Warte auf Passkey-Auswahl...', 'info');
          logDebug('Starte WebAuthn navigator.credentials.get()...');
          logDebug('iOS sollte jetzt ALLE Passkeys fuer diese Domain anzeigen');

          // Schritt 2: WebAuthn-Authentifizierung starten
          const credential = await navigator.credentials.get({
            publicKey: options
          });

          logDebug('Credential erhalten!');
          logDebug('Credential ID: ' + credential.id);

          // userHandle enthaelt den Username bei Discoverable Credentials
          const userHandle = credential.response.userHandle;
          let username = null;
          if (userHandle) {
            username = new TextDecoder().decode(userHandle);
            logDebug('Username aus userHandle: ' + username);
          } else {
            logDebug('Kein userHandle vorhanden');
          }

          // Credential-Daten formatieren
          const credentialData = {
            id: credential.id,
            rawId: arrayBufferToBase64(credential.rawId),
            response: {
              authenticatorData: arrayBufferToBase64(credential.response.authenticatorData),
              clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON),
              signature: arrayBufferToBase64(credential.response.signature),
              userHandle: userHandle ? arrayBufferToBase64(userHandle) : null
            },
            type: credential.type
          };

          logDebug('Sende Credential zur Verifikation...');
          logDebug(JSON.stringify(credentialData, null, 2));

          // Schritt 3: Verifikation beim Server (Discoverable-spezifischer Endpunkt)
          const verifyRes = await fetch(`${API_URL}/login/discoverable/verify`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              assertion: credentialData,
              sessionId: sessionId // Fuer Challenge-Lookup, User wird via credentialId identifiziert
            })
          });

          const verifyResult = await verifyRes.json();
          logDebug('Server-Verifikation Antwort:');
          logDebug(JSON.stringify(verifyResult, null, 2));

          if (verifyResult.success) {
            updateStatus(`<strong>Login erfolgreich!</strong><br>Benutzer: ${username || 'Unbekannt'}`, 'success');
            logDebug('=== LOGIN ERFOLGREICH ===');
            navigateBackToApp('success', username);
          } else {
            const errorMsg = verifyResult.error || 'Unbekannter Fehler';
            updateStatus(`<strong>Login fehlgeschlagen</strong><br>${errorMsg}`, 'error');
            logDebug('=== LOGIN FEHLGESCHLAGEN ===');
            navigateBackToApp('error', username, errorMsg);
          }

        } catch (error) {
          console.error("Fehler beim Login:", error);
          updateStatus(`<strong>Fehler</strong><br>${error.message}`, 'error');
          logDebug('FEHLER: ' + error.message);
          navigateBackToApp('error', null, error.message);
        }
      }

      /**
       * Opens this page via PasskeyGuard deeplink flow
       */
      function openViaDeeplink() {
        const currentUrl = window.location.origin + window.location.pathname;
        const returnUrl = window.location.href;
        const deeplink = `passkeyguard://open?origin=${encodeURIComponent(currentUrl)}&returnURL=${encodeURIComponent(returnUrl)}`;

        logDebug(`Opening via deeplink: ${deeplink}`);
        window.location.href = deeplink;
      }

      // Initial
      logDebug('Discoverable Login Seite geladen');
      logDebug('Flow: allowCredentials = [] (leer)');
      updateStatus('Bereit fuer Discoverable Login', 'info');
    </script>
  </body>
</html>
